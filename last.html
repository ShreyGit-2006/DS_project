<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gitam Library System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <style>
    /* Slightly improved modal backdrop */
    .modal-backdrop { background: rgba(2,6,23,0.6); }
  </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-white to-slate-100 min-h-screen flex">
  <!-- Sidebar -->
  <aside id="sidebar" class="w-64 bg-white shadow-lg flex flex-col transition-all duration-200">
    <div class="h-14 flex items-center justify-between px-4 border-b">
      <span class="font-semibold text-lg">Gitam Library</span>
      <button id="toggleSidebar" class="p-2 rounded hover:bg-gray-100" title="Collapse">
        <i data-lucide="panel-left-close" class="w-5 h-5"></i>
      </button>
    </div>

    <nav class="flex-1 overflow-y-auto p-2">
      <ul class="space-y-1">
        <li><a href="#/dashboard" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="layout-dashboard" class="w-5 h-5"></i><span class="link-text">Dashboard</span></a></li>
        <li><a href="#/add-book" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="book-open" class="w-5 h-5"></i><span class="link-text">Add Book</span></a></li>
        <li><a href="#/add-member" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="user-plus" class="w-5 h-5"></i><span class="link-text">Add Member</span></a></li>
        <li><a href="#/checkout-return" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="clipboard-list" class="w-5 h-5"></i><span class="link-text">Checkout / Return</span></a></li>
        <li><a href="#/reservations" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="list-ordered" class="w-5 h-5"></i><span class="link-text">Reservations</span></a></li>
        <li><a href="#/recommendations" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="star" class="w-5 h-5"></i><span class="link-text">Recommendations</span></a></li>
        <li><a href="#/members" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="users" class="w-5 h-5"></i><span class="link-text">Members</span></a></li>
        <li><a href="#/favorites" class="nav-link flex items-center gap-3 px-3 py-2 rounded hover:bg-blue-50">
          <i data-lucide="heart" class="w-5 h-5"></i><span class="link-text">Favorites</span></a></li>
      </ul>

      <div class="mt-4 border-t pt-3 space-y-1">
        <button id="exportData" class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-green-50 text-green-700">
          <i data-lucide="download" class="w-5 h-5"></i><span class="link-text">Export Data</span>
        </button>
        <button id="clearData" class="w-full flex items-center gap-3 px-3 py-2 rounded hover:bg-red-50 text-red-700">
          <i data-lucide="trash-2" class="w-5 h-5"></i><span class="link-text">Clear All</span>
        </button>
      </div>
    </nav>

    <div class="p-3 text-xs text-center text-gray-500 border-t">Â© 2025</div>
  </aside>

  <!-- Main shell -->
  <div class="flex-1 flex flex-col">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-3 shadow-md">
      <div class="px-4 flex items-center gap-3 justify-between">
        <div class="flex items-center gap-3">
          <button id="openSidebar" class="md:hidden p-2 rounded hover:bg-blue-700">
            <i data-lucide="panel-right-open" class="w-5 h-5"></i>
          </button>
          <h1 class="text-2xl font-semibold">Gitam Library System</h1>
        </div>

        <!-- Global search -->
        <div class="relative">
          <input id="globalSearch" type="text" placeholder="Search books..."
            class="w-64 md:w-80 rounded-md px-3 py-2 text-sm text-gray-800 placeholder-gray-200 bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-white/60" />
          <span class="absolute right-2 top-1/2 -translate-y-1/2 text-white/90">
            <i data-lucide="search" class="w-4 h-4"></i>
          </span>
        </div>

        <div class="flex items-center gap-4">
          <div id="routeTitle" class="text-sm opacity-90">Dashboard</div>
          <!-- Undo & Loan History controls (visible on dashboard) -->
          <button id="undoBtn" class="hidden md:inline-flex items-center gap-2 bg-yellow-400 hover:bg-yellow-500 text-black px-3 py-1 rounded">
            <i data-lucide="corner-up-left" class="w-4 h-4"></i> Undo Last
          </button>
          <button id="viewLoanHistoryBtn" class="hidden md:inline-flex items-center gap-2 bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded">
            <i data-lucide="clock" class="w-4 h-4"></i> View Loan History
          </button>
        </div>
      </div>
    </header>

    <main id="app" class="flex-1 p-6 overflow-y-auto"></main>
  </div>

  <!-- Loan History Modal -->
  <div id="loanHistoryModal" class="fixed inset-0 hidden items-center justify-center modal-backdrop z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 class="text-lg font-semibold">Loan History (LinkedList)</h3>
        <button id="closeLoanModal" class="p-2 rounded hover:bg-gray-100"><i data-lucide="x" class="w-5 h-5"></i></button>
      </div>
      <div class="p-4 max-h-96 overflow-auto">
        <table class="w-full text-left">
          <thead class="bg-slate-100">
            <tr>
              <th class="p-2">Idx</th>
              <th class="p-2">Loan ID</th>
              <th class="p-2">Book ID</th>
              <th class="p-2">Member ID</th>
              <th class="p-2">Action</th>
              <th class="p-2">Date</th>
            </tr>
          </thead>
          <tbody id="loanHistoryBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Icons
    lucide.createIcons();

    // Sidebar collapse
    const sidebar = document.getElementById('sidebar');
    const toggleBtn = document.getElementById('toggleSidebar');
    const openBtn = document.getElementById('openSidebar');
    let collapsed = false;
    function applySidebarState() {
      if (collapsed) {
        sidebar.classList.add('w-16');
        sidebar.classList.remove('w-64');
        document.querySelectorAll('#sidebar .link-text').forEach(el => el.classList.add('hidden'));
        toggleBtn.title = 'Expand';
      } else {
        sidebar.classList.remove('w-16');
        sidebar.classList.add('w-64');
        document.querySelectorAll('#sidebar .link-text').forEach(el => el.classList.remove('hidden'));
        toggleBtn.title = 'Collapse';
      }
    }
    toggleBtn.addEventListener('click', () => { collapsed = !collapsed; applySidebarState(); });
    openBtn.addEventListener('click', () => { collapsed = false; applySidebarState(); });
    applySidebarState();

    // ---------- Data stores (original) ----------
    let books = JSON.parse(localStorage.getItem('books') || '[]');
    let members = JSON.parse(localStorage.getItem('members') || '[]');
    let loans = JSON.parse(localStorage.getItem('loans') || '[]');
    let reservations = JSON.parse(localStorage.getItem('reservations') || '{}');
    let recs = JSON.parse(localStorage.getItem('recs') || '{}');
    let loanCounter = parseInt(localStorage.getItem('loanCounter') || '1000', 10);

    // Favorites/search state
    let favoritesThreshold = parseInt(localStorage.getItem('favoritesThreshold') || '10', 10);
    let searchQuery = '';

    const todayStr = () => new Date().toISOString().slice(0,10);
    const addDaysStr = (days) => { const d=new Date(); d.setDate(d.getDate()+days); return d.toISOString().slice(0,10); };

    function persistAll(){
      localStorage.setItem('books', JSON.stringify(books));
      localStorage.setItem('members', JSON.stringify(members));
      localStorage.setItem('loans', JSON.stringify(loans));
      localStorage.setItem('reservations', JSON.stringify(reservations));
      localStorage.setItem('recs', JSON.stringify(recs));
      localStorage.setItem('loanCounter', String(loanCounter));
      localStorage.setItem('favoritesThreshold', String(favoritesThreshold));
    }

    // Helpers
    function findBook(bookId){ return books.find(b => b.bookId === Number(bookId)); }
    function findMember(memberId){ return members.find(m => m.memberId === Number(memberId)); }
    function loansByBookId(bookId){ return loans.filter(L => L.bookId === Number(bookId)); }
    function activeLoansCountByBook(bookId){ return loansByBookId(bookId).length; }
    function isFavoriteBook(book){ return activeLoansCountByBook(book.bookId) >= favoritesThreshold; }

    function filterBooks(arr){
      if(!searchQuery) return arr;
      return arr.filter(b=>{
        const s = `${b.bookId} ${b.title} ${b.author}`.toLowerCase();
        return s.includes(searchQuery);
      });
    }

    // ---------------- Data Structure Additions ----------------

    // Stack for Undo
    class Stack {
      constructor(){ this.items = []; }
      push(x){ this.items.push(x); }
      pop(){ return this.items.pop(); }
      peek(){ return this.items[this.items.length - 1]; }
      isEmpty(){ return this.items.length === 0; }
      size(){ return this.items.length; }
    }
    const actionHistory = new Stack();

    function recordAction(type, data){
      // store a compact record to revert actions later
      actionHistory.push({ type, data, ts: new Date().toISOString() });
      // keep size reasonable
      if(actionHistory.size() > 100) actionHistory.items.shift();
      document.getElementById('undoBtn')?.classList.remove('hidden');
    }

    // Linked List for Loan History
    class LLNode {
      constructor(entry) { this.entry = entry; this.next = null; }
    }
    class LinkedList {
      constructor(){ this.head = null; this.size = 0; }
      add(entry){
        const n = new LLNode(entry);
        if(!this.head) this.head = n;
        else {
          let cur = this.head;
          while(cur.next) cur = cur.next;
          cur.next = n;
        }
        this.size++;
      }
      toArray(){
        const out = [];
        let cur = this.head;
        let idx = 0;
        while(cur){
          out.push({ idx: idx++, ...cur.entry });
          cur = cur.next;
        }
        return out;
      }
    }
    const loanHistory = new LinkedList();

    // When page loads, rebuild loanHistory from existing loans (historical)
    (function rebuildLoanHistoryFromLoans(){
      // if any loans exist, create history entries
      loans.forEach(L => {
        loanHistory.add({
          loanId: L.loanId || null,
          bookId: L.bookId,
          memberId: L.memberId,
          action: 'LOAN (existing)',
          date: L.checkoutDate || todayStr()
        });
      });
    })();

    // ---------------- Modified Checkout / Return with records ----------------

    // Quantity-aware checkout/return (modified to record actions & loanHistory)
    function checkoutBookQty(bookId, memberId, qty){
      const b = findBook(bookId); const m = findMember(memberId);
      if(!b) { alert('Book not found'); return false; }
      if(!m) { alert('Member not found'); return false; }

      const currentLoans = loans.filter(L => L.memberId === Number(memberId)).length;
      const capacity = (m.maxLoans || 5) - currentLoans;
      if(capacity <= 0){ alert('Member reached max loans'); return false; }

      const want = Math.max(1, qty|0);
      const canFromAvailability = Math.max(0, b.availableCopies);
      const toIssue = Math.min(want, capacity, canFromAvailability);

      const createdLoanIds = [];
      if(toIssue > 0){
        const cd = todayStr();
        const due = addDaysStr(14);
        for(let i=0;i<toIssue;i++){
          const loanId = loanCounter++;
          const loanObj = { loanId, bookId: b.bookId, memberId: m.memberId, checkoutDate: cd, dueDate: due };
          loans.push(loanObj);
          // add to loan history as LOAN action
          loanHistory.add({ loanId, bookId: b.bookId, memberId: m.memberId, action: 'LOAN', date: cd });
          createdLoanIds.push(loanId);
        }
        b.availableCopies -= toIssue;
      }

      const notIssued = want - toIssue;
      if(notIssued > 0){
        if(!reservations[b.bookId]) reservations[b.bookId] = [];
        if(!reservations[b.bookId].includes(m.memberId)){
          reservations[b.bookId].push(m.memberId);
        }
        alert(`Issued ${toIssue}. Added to reservation queue for remaining ${notIssued}.`);
      } else {
        alert(`Issued ${toIssue}.`);
      }

      // record action for undo
      if(createdLoanIds.length > 0){
        recordAction('checkout', { bookId: b.bookId, memberId: m.memberId, loanIds: createdLoanIds, qty: createdLoanIds.length });
      } else {
        // if nothing created, don't push checkout action
      }

      persistAll(); router.render(); return true;
    }

    function returnBookQty(bookId, memberId, qty){
      const b = findBook(bookId); const m = findMember(memberId);
      if(!b || !m) { alert('Book or Member not found'); return false; }

      const matches = loans.filter(L => L.bookId === Number(bookId) && L.memberId === Number(memberId));
      if(matches.length === 0){ alert('No matching loans for this member and book'); return false; }

      const want = Math.max(1, qty|0);
      const toReturn = Math.min(want, matches.length);
      const returnedLoanIds = [];
      let reassigned = 0;
      for(let i=0;i<toReturn;i++){
        const idx = loans.findIndex(L => L.bookId === Number(bookId) && L.memberId === Number(memberId));
        if(idx !== -1){
          const removed = loans.splice(idx,1)[0];
          returnedLoanIds.push(removed.loanId || null);
        }

        const q = reservations[b.bookId] || [];
        if(q.length > 0){
          const nextMid = q.shift();
          const cd = todayStr();
          const due = addDaysStr(14);
          const loanId = loanCounter++;
          loans.push({ loanId, bookId: b.bookId, memberId: Number(nextMid), checkoutDate: cd, dueDate: due });
          // record reassigned loan in history
          loanHistory.add({ loanId, bookId: b.bookId, memberId: Number(nextMid), action: 'LOAN (from reservation)', date: cd });
          reassigned++;
        } else {
          b.availableCopies += 1;
        }
      }

      // record action for undo (return)
      recordAction('return', { bookId: b.bookId, memberId: m.memberId, loanIds: returnedLoanIds, qty: returnedLoanIds.length, reassigned });

      persistAll(); router.render();
      if(reassigned > 0){
        alert(`Returned ${toReturn}. Auto-assigned ${reassigned} to next reservations.`);
      } else {
        alert(`Returned ${toReturn}. Available copies: ${b.availableCopies}.`);
      }
      return true;
    }

    // ---------------- Add/Member/Recs should record actions ----------------
    function addBookDirect(book){
      books.push(book);
      persistAll();
      recordAction('addBook', { bookId: book.bookId });
      router.render();
      alert('Book added');
    }
    function addMemberDirect(member){
      members.push(member);
      persistAll();
      recordAction('addMember', { memberId: member.memberId });
      router.render();
      alert('Member added');
    }
    function addRecommendationDirect(teacher, bid){
      if(!recs[teacher]) recs[teacher]=[];
      if(!recs[teacher].includes(bid)) recs[teacher].push(bid);
      persistAll();
      recordAction('recommend', { teacher, bookId: bid });
      router.render();
      alert('Recommendation recorded');
    }

    // ---------------- Undo Implementation ----------------
    function undoLastAction(){
      if(actionHistory.isEmpty()){ alert('No actions to undo.'); return; }
      const last = actionHistory.pop();
      const t = last.type;
      const d = last.data;

      if(t === 'addBook'){
        // remove the book if exists and no active loans for it
        const idx = books.findIndex(b => b.bookId === d.bookId);
        if(idx !== -1){
          // but only remove if no active loans exist for the book
          const active = loansByBookId(d.bookId).length;
          if(active > 0){
            alert('Cannot undo addBook: active loans exist for this book.');
            // since undo failed, push back action to history
            actionHistory.push(last);
            return;
          }
          books.splice(idx,1);
          persistAll();
          router.render();
          alert(`Undo: Book ${d.bookId} removed.`);
          return;
        } else {
          alert('Undo: Book not found (maybe already removed).');
          return;
        }
      }

      if(t === 'addMember'){
        const idx = members.findIndex(m => m.memberId === d.memberId);
        if(idx !== -1){
          // only remove if member has no active loans
          const active = loans.filter(L => L.memberId === d.memberId).length;
          if(active > 0){
            alert('Cannot undo addMember: member has active loans.');
            actionHistory.push(last);
            return;
          }
          members.splice(idx,1);
          persistAll();
          router.render();
          alert(`Undo: Member ${d.memberId} removed.`);
          return;
        } else {
          alert('Undo: Member not found (maybe already removed).');
          return;
        }
      }

      if(t === 'checkout'){
        // remove the created loans and restore availableCopies
        const { bookId, memberId, loanIds } = d;
        let removedCount = 0;
        loanIds.forEach(lid => {
          const idx = loans.findIndex(L => L.loanId === lid);
          if(idx !== -1){
            loans.splice(idx,1);
            removedCount++;
          }
        });
        // restore copies
        const b = findBook(bookId);
        if(b) b.availableCopies += removedCount;
        persistAll();
        router.render();
        alert(`Undo: Removed ${removedCount} loan(s) from last checkout.`);
        return;
      }

      if(t === 'return'){
        // For returned loans, undo is complex because some returns might have caused reassignments.
        // We'll attempt to restore the returned loans to the member if possible by creating new loan entries.
        const { bookId, memberId, loanIds, qty, reassigned } = d;
        const b = findBook(bookId);
        const restoredIds = [];
        // restore as new loans (can't resurrect original loanIds reliably)
        for(let i=0;i<qty;i++){
          if(b && b.availableCopies > 0){
            const loanId = loanCounter++;
            const cd = todayStr();
            const due = addDaysStr(14);
            loans.push({ loanId, bookId, memberId, checkoutDate: cd, dueDate: due });
            loanHistory.add({ loanId, bookId, memberId, action: 'LOAN (undo-return)', date: cd });
            b.availableCopies -= 1;
            restoredIds.push(loanId);
          } else {
            // if no copies available (because they were reassigned), skip
          }
        }
        persistAll();
        router.render();
        alert(`Undo: Restored ${restoredIds.length} loan(s) for Member ${memberId} (best-effort).`);
        return;
      }

      if(t === 'recommend'){
        const { teacher, bookId } = d;
        if(recs[teacher]){
          const idx = recs[teacher].indexOf(bookId);
          if(idx !== -1) recs[teacher].splice(idx,1);
          if(recs[teacher].length === 0) delete recs[teacher];
        }
        persistAll(); router.render();
        alert(`Undo: Recommendation removed.`);
        return;
      }

      alert('Undo: Action type not recognized.');
    }

    // Wire undo button
    document.getElementById('undoBtn').addEventListener('click', ()=> {
      undoLastAction();
    });

    // ---------------- Loan History Modal UI ----------------
    const loanModal = document.getElementById('loanHistoryModal');
    const viewLoanBtn = document.getElementById('viewLoanHistoryBtn');
    const closeLoanModal = document.getElementById('closeLoanModal');
    const loanHistoryBody = document.getElementById('loanHistoryBody');

    function showLoanHistoryModal(){
      // populate table from linked list
      const arr = loanHistory.toArray();
      loanHistoryBody.innerHTML = arr.map(row => `
        <tr class="border-b">
          <td class="p-2">${row.idx}</td>
          <td class="p-2">${row.loanId ?? '-'}</td>
          <td class="p-2">${row.bookId}</td>
          <td class="p-2">${row.memberId}</td>
          <td class="p-2">${row.action}</td>
          <td class="p-2">${row.date}</td>
        </tr>
      `).join('') || '<tr><td class="p-2" colspan="6">No history yet.</td></tr>';

      loanModal.classList.remove('hidden');
      loanModal.classList.add('flex');
    }
    viewLoanBtn.addEventListener('click', showLoanHistoryModal);
    closeLoanModal.addEventListener('click', ()=>{ loanModal.classList.add('hidden'); loanModal.classList.remove('flex'); });

    // Also bind modal open for small screens (buttons hidden on md; provide floating action on dashboard)
    // We'll show the floating buttons on the dashboard view where appropriate during render.

    // ---------------- Views (unchanged core structure, with small tweaks to use new helpers) ----------------
    const Views = {
      dashboard() {
        return `
          <section class="grid md:grid-cols-2 gap-6">
            <div class="bg-white rounded-xl shadow p-5">
              <div class="flex items-center justify-between mb-3">
                <h2 class="text-xl font-semibold">Books</h2>
                <span class="text-sm text-gray-500">Favorites threshold: ${favoritesThreshold}</span>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                  <thead class="bg-gray-200">
                    <tr>
                      <th class="p-2">Book ID</th>
                      <th class="p-2">Title</th>
                      <th class="p-2">Author</th>
                      <th class="p-2">Total</th>
                      <th class="p-2">Available</th>
                      <th class="p-2">Active Loans</th>
                      <th class="p-2">Reserved</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${filterBooks(books).map(b => `
                      <tr class="border-b">
                        <td class="p-2">${b.bookId}</td>
                        <td class="p-2 flex items-center gap-2">
                          ${isFavoriteBook(b) ? '<i data-lucide="heart" class="w-4 h-4 text-rose-600"></i>' : ''}
                          ${b.title}
                        </td>
                        <td class="p-2">${b.author}</td>
                        <td class="p-2">${b.totalCopies}</td>
                        <td class="p-2">${b.availableCopies}</td>
                        <td class="p-2">${activeLoansCountByBook(b.bookId)}</td>
                        <td class="p-2">${(reservations[b.bookId]||[]).length}</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>

              <h3 class="mt-6 text-lg font-semibold">Active Loans</h3>
              <div class="overflow-x-auto">
                <table class="w-full mt-2 text-left">
                  <thead class="bg-gray-200">
                    <tr>
                      <th class="p-2">Loan ID</th>
                      <th class="p-2">Book ID</th>
                      <th class="p-2">Member ID</th>
                      <th class="p-2">Checkout</th>
                      <th class="p-2">Due Date</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${loans.map(L => `
                      <tr class="border-b">
                        <td class="p-2">${L.loanId}</td>
                        <td class="p-2">${L.bookId}</td>
                        <td class="p-2">${L.memberId}</td>
                        <td class="p-2">${L.checkoutDate}</td>
                        <td class="p-2">${L.dueDate}</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>

            <div class="space-y-6">
              <div class="bg-white rounded-xl shadow p-5">
                <div class="flex items-center justify-between mb-3">
                  <h2 class="text-xl font-semibold">Reservations</h2>
                  <div class="flex items-center gap-2">
                    <button id="floatingViewHistory" class="inline-flex items-center gap-2 bg-indigo-600 text-white px-3 py-1 rounded">
                      <i data-lucide="clock" class="w-4 h-4"></i> Loan History
                    </button>
                    <button id="floatingUndo" class="inline-flex items-center gap-2 bg-yellow-400 text-black px-3 py-1 rounded">
                      <i data-lucide="corner-up-left" class="w-4 h-4"></i> Undo
                    </button>
                  </div>
                </div>
                <div class="overflow-x-auto">
                  <table class="w-full text-left">
                    <thead class="bg-gray-200">
                      <tr>
                        <th class="p-2">Book ID</th>
                        <th class="p-2">Queue</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${filterBooks(books).map(b => {
                        const q = reservations[b.bookId] || [];
                        return `
                          <tr class="border-b">
                            <td class="p-2">${b.bookId}</td>
                            <td class="p-2">${q.join(', ')}</td>
                          </tr>`;
                      }).join('')}
                    </tbody>
                  </table>
                </div>
              </div>

              <div class="bg-white rounded-xl shadow p-5">
                <h2 class="text-xl font-semibold mb-3">Teacher Recommendations</h2>
                <div class="overflow-x-auto">
                  <table class="w-full text-left">
                    <thead class="bg-gray-200">
                      <tr>
                        <th class="p-2">Teacher</th>
                        <th class="p-2">Book IDs</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${Object.keys(recs).sort().map(t => `
                        <tr class="border-b">
                          <td class="p-2">${t}</td>
                          <td class="p-2">${recs[t].join(', ')}</td>
                        </tr>`).join('')}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>
        `;
      },

      addBook() {
        return `
          <section class="max-w-xl bg-white rounded-xl shadow p-5">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="book-open"></i> Add Book</h2>
            <form id="bookForm" class="space-y-2">
              <input type="number" id="bookId" placeholder="Book ID" class="w-full border rounded p-2" required>
              <input type="text" id="bookTitle" placeholder="Title" class="w-full border rounded p-2" required>
              <input type="text" id="bookAuthor" placeholder="Author" class="w-full border rounded p-2" required>
              <input type="number" id="bookCopies" placeholder="Total Copies" class="w-full border rounded p-2" required>
              <button class="bg-blue-600 text-white w-full py-2 rounded hover:bg-blue-700">Add Book</button>
            </form>
          </section>
        `;
      },

      addMember() {
        return `
          <section class="max-w-xl bg-white rounded-xl shadow p-5">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="user-plus"></i> Add Member</h2>
            <form id="memberForm" class="space-y-2">
              <input type="number" id="memberId" placeholder="Member ID" class="w-full border rounded p-2" required>
              <input type="text" id="memberName" placeholder="Name" class="w-full border rounded p-2" required>
              <input type="number" id="maxLoans" placeholder="Max Loan Limit (default 5)" class="w-full border rounded p-2">
              <button class="bg-green-600 text-white w-full py-2 rounded hover:bg-green-700">Add Member</button>
            </form>
          </section>
        `;
      },

      checkoutReturn() {
        return `
          <section class="max-w-xl bg-white rounded-xl shadow p-5">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="clipboard-list"></i> Checkout / Return Book</h2>
            <form id="checkoutForm" class="space-y-2">
              <input type="number" id="checkoutBookId" placeholder="Book ID" class="w-full border rounded p-2" required>
              <input type="number" id="checkoutMemberId" placeholder="Member ID" class="w-full border rounded p-2" required>
              <input type="number" id="checkoutQty" placeholder="Quantity (default 1)" min="1" class="w-full border rounded p-2">
              <div class="flex gap-2">
                <button id="checkoutBtn" type="button" class="bg-indigo-600 text-white flex-1 py-2 rounded hover:bg-indigo-700">Checkout</button>
                <button id="returnBtn" type="button" class="bg-red-600 text-white flex-1 py-2 rounded hover:bg-red-700">Return</button>
              </div>
            </form>
            <p class="text-sm text-gray-500 mt-3">Quantity applies to both checkout and return; constrained by availability and member loan limit.</p>
          </section>
        `;
      },

      reservations() {
        return `
          <section class="bg-white rounded-xl shadow p-5">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="list-ordered"></i> Reservations</h2>
            <div class="overflow-x-auto">
              <table class="w-full text-left">
                <thead class="bg-gray-200">
                  <tr>
                    <th class="p-2">Book ID</th>
                    <th class="p-2">Queue (Member IDs)</th>
                  </tr>
                </thead>
                <tbody>
                  ${filterBooks(books).map(b => {
                    const q = reservations[b.bookId] || [];
                    return `
                      <tr class="border-b">
                        <td class="p-2">${b.bookId}</td>
                        <td class="p-2">${q.join(', ')}</td>
                      </tr>`;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </section>
        `;
      },

      recommendations() {
        return `
          <section class="space-y-6">
            <div class="max-w-xl bg-white rounded-xl shadow p-5">
              <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="star"></i> Teacher Recommendation</h2>
              <form id="recommendForm" class="space-y-2">
                <input type="text" id="teacherName" placeholder="Teacher Name" class="w-full border rounded p-2" required>
                <input type="number" id="recommendBookId" placeholder="Book ID" class="w-full border rounded p-2" required>
                <button class="bg-yellow-500 text-white w-full py-2 rounded hover:bg-yellow-600">Add Recommendation</button>
              </form>
            </div>

            <div class="bg-white rounded-xl shadow p-5">
              <h3 class="text-lg font-semibold mb-3">All Recommendations</h3>
              <div class="overflow-x-auto">
                <table class="w-full text-left">
                  <thead class="bg-gray-200">
                    <tr>
                      <th class="p-2">Teacher</th>
                      <th class="p-2">Book IDs</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${Object.keys(recs).sort().map(t => `
                      <tr class="border-b">
                        <td class="p-2">${t}</td>
                        <td class="p-2">${recs[t].join(', ')}</td>
                      </tr>`).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </section>
        `;
      },

      members() {
        return `
          <section class="bg-white rounded-xl shadow p-5">
            <h2 class="text-xl font-semibold mb-4 flex items-center gap-2"><i data-lucide="users"></i> All Members</h2>
            <div class="overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead class="bg-gray-200">
                  <tr>
                    <th class="p-2">Member ID</th>
                    <th class="p-2">Name</th>
                    <th class="p-2">Max Loans</th>
                    <th class="p-2">Current Loans</th>
                  </tr>
                </thead>
                <tbody>
                  ${members.map(m => `
                    <tr class="border-b">
                      <td class="p-2">${m.memberId}</td>
                      <td class="p-2">${m.name}</td>
                      <td class="p-2">${m.maxLoans || 5}</td>
                      <td class="p-2">${loans.filter(L => L.memberId === m.memberId).length}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
            </div>
          </section>
        `;
      },

      favorites() {
        const favs = filterBooks(books).filter(isFavoriteBook);
        return `
          <section class="space-y-6">
            <div class="bg-white rounded-xl shadow p-5">
              <div class="flex items-center justify-between">
                <h2 class="text-xl font-semibold flex items-center gap-2">
                  <i data-lucide="heart"></i> Favorites
                </h2>
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-600">Threshold</label>
                  <input id="favThreshold" type="number" min="1" class="w-20 border rounded px-2 py-1"
                    value="${favoritesThreshold}">
                </div>
              </div>
              <p class="text-sm text-gray-500 mt-2">
                Books are favorites when active loans â¥ threshold. Current threshold: ${favoritesThreshold}.
              </p>
            </div>

            <div class="bg-white rounded-xl shadow p-5 overflow-x-auto">
              <table class="w-full text-left border-collapse">
                <thead class="bg-gray-200">
                  <tr>
                    <th class="p-2">Book ID</th>
                    <th class="p-2">Title</th>
                    <th class="p-2">Author</th>
                    <th class="p-2">Active Loans</th>
                  </tr>
                </thead>
                <tbody>
                  ${favs.map(b => `
                    <tr class="border-b">
                      <td class="p-2">${b.bookId}</td>
                      <td class="p-2 flex items-center gap-2">
                        <i data-lucide="heart" class="w-4 h-4 text-rose-600"></i>${b.title}
                      </td>
                      <td class="p-2">${b.author}</td>
                      <td class="p-2">${activeLoansCountByBook(b.bookId)}</td>
                    </tr>`).join('')}
                </tbody>
              </table>
              ${favs.length === 0 ? '<div class="text-sm text-gray-500 mt-3">No favorites yet.</div>' : ''}
            </div>
          </section>
        `;
      },

      notFound() {
        return `<div class="text-center text-gray-600">Page not found</div>`;
      }
    };

    // ---------------- Router (mostly same) ----------------
    const routeTitle = document.getElementById('routeTitle');
    const app = document.getElementById('app');
    const routes = {
      '/': { view: 'dashboard', title: 'Dashboard' },
      '/dashboard': { view: 'dashboard', title: 'Dashboard' },
      '/add-book': { view: 'addBook', title: 'Add Book' },
      '/add-member': { view: 'addMember', title: 'Add Member' },
      '/checkout-return': { view: 'checkoutReturn', title: 'Checkout / Return' },
      '/reservations': { view: 'reservations', title: 'Reservations' },
      '/recommendations': { view: 'recommendations', title: 'Recommendations' },
      '/members': { view: 'members', title: 'Members' },
      '/favorites': { view: 'favorites', title: 'Favorites' },
    };

    const router = {
      parse() {
        const hash = window.location.hash || '#/dashboard';
        const path = hash.replace('#', '');
        return path || '/dashboard';
      },
      mountEventsForView(viewName){
        if(viewName === 'addBook'){
          document.getElementById('bookForm')?.addEventListener('submit', e => {
            e.preventDefault();
            const id = Number(document.getElementById('bookId').value);
            if(findBook(id)){ alert('Book ID already exists'); return; }
            const book = {
              bookId: id,
              title: document.getElementById('bookTitle').value,
              author: document.getElementById('bookAuthor').value,
              totalCopies: Number(document.getElementById('bookCopies').value),
              availableCopies: Number(document.getElementById('bookCopies').value)
            };
            addBookDirect(book);
            window.location.hash = '#/dashboard';
          });
        }
        if(viewName === 'addMember'){
          document.getElementById('memberForm')?.addEventListener('submit', e => {
            e.preventDefault();
            const id = Number(document.getElementById('memberId').value);
            if(findMember(id)){ alert('Member ID already exists'); return; }
            const member = {
              memberId: id,
              name: document.getElementById('memberName').value,
              maxLoans: Number(document.getElementById('maxLoans').value) || 5
            };
            addMemberDirect(member);
            window.location.hash = '#/members';
          });
        }
        if(viewName === 'checkoutReturn'){
          document.getElementById('checkoutBtn')?.addEventListener('click', ()=>{
            const bid = Number(document.getElementById('checkoutBookId').value);
            const mid = Number(document.getElementById('checkoutMemberId').value);
            const qty = Number(document.getElementById('checkoutQty').value) || 1;
            if(!bid || !mid) return alert('Enter both Book ID and Member ID');
            checkoutBookQty(bid, mid, qty);
            document.getElementById('checkoutForm').reset();
          });
          document.getElementById('returnBtn')?.addEventListener('click', ()=>{
            const bid = Number(document.getElementById('checkoutBookId').value);
            const mid = Number(document.getElementById('checkoutMemberId').value);
            const qty = Number(document.getElementById('checkoutQty').value) || 1;
            if(!bid || !mid) return alert('Enter both Book ID and Member ID');
            returnBookQty(bid, mid, qty);
            document.getElementById('checkoutForm').reset();
          });
        }
        if(viewName === 'recommendations'){
          document.getElementById('recommendForm')?.addEventListener('submit', e => {
            e.preventDefault();
            const teacher = document.getElementById('teacherName').value.trim().toUpperCase();
            const bid = Number(document.getElementById('recommendBookId').value);
            if(!findBook(bid)){
              if(!confirm('Book not found. Add placeholder book with this ID?')) return;
              books.push({ bookId: bid, title: 'Unknown', author: 'Unknown', totalCopies: 1, availableCopies: 1 });
            }
            addRecommendationDirect(teacher, bid);
            router.render();
          });
        }
        if(viewName === 'favorites'){
          document.getElementById('favThreshold')?.addEventListener('change', (e)=>{
            const v = Math.max(1, parseInt(e.target.value || '10', 10));
            favoritesThreshold = v;
            persistAll();
            router.render();
          });
        }

        // Floating small-screen buttons (bind each time view mounts)
        const floatingUndo = document.getElementById('floatingUndo');
        if(floatingUndo){
          floatingUndo.addEventListener('click', ()=>undoLastAction());
        }
        const floatingViewHistory = document.getElementById('floatingViewHistory');
        if(floatingViewHistory){
          floatingViewHistory.addEventListener('click', showLoanHistoryModal);
        }
      },
      highlightNav(path){
        document.querySelectorAll('.nav-link').forEach(a => {
          const active = a.getAttribute('href') === '#'+path;
          a.classList.toggle('bg-blue-100', active);
          a.classList.toggle('text-blue-700', active);
        });
      },
      render(){
        const path = this.parse();
        const viewName = (routes[path]?.view) || 'notFound';
        const title = (routes[path]?.title) || 'Not Found';
        document.getElementById('routeTitle').textContent = title;
        const html = (Views[viewName] || Views.notFound)();
        app.innerHTML = html;
        lucide.createIcons();
        this.highlightNav(path);
        this.mountEventsForView(viewName);

        // show/hide header controls depending on view
        const undoBtn = document.getElementById('undoBtn');
        const viewLoanBtn = document.getElementById('viewLoanHistoryBtn');
        if(path === '/dashboard' || path === '/'){
          undoBtn?.classList.remove('hidden');
          viewLoanBtn?.classList.remove('hidden');
        } else {
          undoBtn?.classList.add('hidden');
          viewLoanBtn?.classList.add('hidden');
        }
      },
      init(){
        window.addEventListener('hashchange', () => this.render());
        this.render();
      }
    };

    // Global search input binding
    const searchInput = document.getElementById('globalSearch');
    if (searchInput){
      searchInput.addEventListener('input', (e)=>{
        searchQuery = e.target.value.trim().toLowerCase();
        router.render();
      });
    }

    // Sidebar static actions
    document.getElementById('exportData').addEventListener('click', ()=>{
      const payload = { books, members, loans, reservations, recs, loanCounter, favoritesThreshold };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'library_export.json'; a.click(); URL.revokeObjectURL(url);
    });
    document.getElementById('clearData').addEventListener('click', ()=>{
      if(!confirm('Clear ALL stored data?')) return;
      localStorage.clear();
      books = []; members = []; loans = []; reservations = {}; recs = {}; loanCounter = 1000; favoritesThreshold = 10; searchQuery = '';
      // reset history & actions
      while(!actionHistory.isEmpty()) actionHistory.pop();
      // reset linked list
      loanHistory.head = null; loanHistory.size = 0;
      router.render();
      alert('Cleared');
    });

    // Start
    router.init();

    // Expose utility (for console debugging)
    window._lib = { books, members, loans, reservations, recs, loanHistory, actionHistory };
  </script>
</body>
</html>
